{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Dashboard - AI Support Dashboard{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block page_description %}Monitor your AI support system performance{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Conversations -->
    <div class="card-hover glass rounded-2xl shadow-xl p-6 stats-card blue">
        <div class="decoration bg-gradient-to-br from-blue-400 to-purple-500"></div>
        <div class="relative">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-comments text-white text-xl"></i>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-600 mb-1">Total Conversations</p>
            <p class="counter" id="total-conversations">{{ stats.total_conversations|default:0 }}</p>
            <div class="flex items-center mt-3 text-green-600 text-sm font-semibold">
                <i class="fas fa-chart-line mr-1"></i>
                <span>Activity tracking</span>
            </div>
        </div>
    </div>

    <!-- Active Today -->
    <div class="card-hover glass rounded-2xl shadow-xl p-6 stats-card green">
        <div class="decoration bg-gradient-to-br from-emerald-400 to-teal-500"></div>
        <div class="relative">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-bolt text-white text-xl"></i>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-600 mb-1">Active Today</p>
            <p class="counter" id="active-today">0</p>
            <p class="text-sm text-gray-500 mt-3 font-medium">Real-time conversations</p>
        </div>
    </div>

    <!-- Knowledge Base -->
    <div class="card-hover glass rounded-2xl shadow-xl p-6 stats-card purple">
        <div class="decoration bg-gradient-to-br from-purple-400 to-pink-500"></div>
        <div class="relative">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-file-alt text-white text-xl"></i>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-600 mb-1">Knowledge Base</p>
            <p class="counter" id="total-documents">{{ stats.total_documents|default:0 }}</p>
            <p class="text-sm text-gray-500 mt-3 font-medium">Documents uploaded</p>
        </div>
    </div>

    <!-- Avg Response Time -->
    <div class="card-hover glass rounded-2xl shadow-xl p-6 stats-card orange">
        <div class="decoration bg-gradient-to-br from-orange-400 to-red-500"></div>
        <div class="relative">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-clock text-white text-xl"></i>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-600 mb-1">Avg Response Time</p>
            <p class="counter" id="avg-response">--</p>
            <p class="text-sm text-gray-500 mt-3 font-medium">AI processing time</p>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Conversation Trends -->
    <div class="glass rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">Conversation Trends</h3>
            <select id="time-range-select" class="px-4 py-2 glass rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 3 months</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="conversation-chart"></canvas>
        </div>
    </div>

    <!-- Channel Distribution -->
    <div class="glass rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">Channel Distribution</h3>
            <a href="{% url 'dashboard:conversations' %}" class="text-sm font-semibold text-purple-600 hover:text-purple-800 transition-colors">
                View All →
            </a>
        </div>
        <div class="chart-container">
            <canvas id="channel-chart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity & Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Conversations -->
    <div class="lg:col-span-2 glass rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800">Recent Conversations</h3>
                <a href="{% url 'dashboard:conversations' %}" class="text-sm font-semibold text-purple-600 hover:text-purple-800 transition-colors">
                    View All →
                </a>
            </div>
        </div>
        <div class="divide-y divide-gray-100">
            <div id="recent-conversations">
                <div class="loading-state">
                    <i class="fas fa-spinner loading-spinner"></i>
                    <p class="font-medium">Loading recent conversations...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">Quick Actions</h3>
        </div>
        <div class="p-6 space-y-3">
            <a href="{% url 'dashboard:upload' %}" class="quick-action bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100">
                <div class="flex items-center space-x-3">
                    <div class="quick-action-icon bg-gradient-to-br from-blue-500 to-purple-600">
                        <i class="fas fa-upload text-white"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Upload Document</p>
                        <p class="text-sm text-gray-600">Add to knowledge base</p>
                    </div>
                </div>
            </a>

            <a href="{% url 'dashboard:conversations' %}" class="quick-action bg-gradient-to-r from-emerald-50 to-teal-50 hover:from-emerald-100 hover:to-teal-100">
                <div class="flex items-center space-x-3">
                    <div class="quick-action-icon bg-gradient-to-br from-emerald-500 to-teal-600">
                        <i class="fas fa-comments text-white"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">View Conversations</p>
                        <p class="text-sm text-gray-600">Monitor customer chats</p>
                    </div>
                </div>
            </a>

            <button onclick="testChatWidget()" class="quick-action w-full text-left bg-gradient-to-r from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100">
                <div class="flex items-center space-x-3">
                    <div class="quick-action-icon bg-gradient-to-br from-purple-500 to-pink-600">
                        <i class="fas fa-play text-white"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Test Chat Widget</p>
                        <p class="text-sm text-gray-600">Preview customer experience</p>
                    </div>
                </div>
            </button>

            <button onclick="openEmailTestModal()" class="quick-action w-full text-left bg-gradient-to-r from-orange-50 to-red-50 hover:from-orange-100 hover:to-red-100">
                <div class="flex items-center space-x-3">
                    <div class="quick-action-icon bg-gradient-to-br from-orange-500 to-red-600">
                        <i class="fas fa-envelope text-white"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Test Email</p>
                        <p class="text-sm text-gray-600">Send test email response</p>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="mt-8 glass rounded-2xl shadow-xl">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-800">System Status</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="status-item">
                <div class="status-icon operational">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <p class="font-semibold text-gray-800">AI Model</p>
                    <p class="text-sm text-emerald-600 font-medium">Operational</p>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon operational">
                    <i class="fas fa-database text-white"></i>
                </div>
                <div>
                    <p class="font-semibold text-gray-800">Database</p>
                    <p class="text-sm text-emerald-600 font-medium">Connected</p>
                </div>
            </div>
            <div class="status-item">
                <div class="status-icon operational">
                    <i class="fas fa-server text-white"></i>
                </div>
                <div>
                    <p class="font-semibold text-gray-800">API Services</p>
                    <p class="text-sm text-emerald-600 font-medium">All systems online</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Test Modal -->
<div id="email-test-modal" class="modal-backdrop hidden" data-modal-backdrop onclick="closeEmailTestModal(event)">
    <div class="modal-content glass-dark rounded-2xl shadow-2xl p-8" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-white">Test Email Response</h3>
            <button onclick="closeEmailTestModal()" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="email-test-form" onsubmit="sendTestEmail(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Recipient Email</label>
                <input type="email" id="test-email-recipient" required
                    class="modal-input"
                    placeholder="customer@example.com">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Subject</label>
                <input type="text" id="test-email-subject" required
                    class="modal-input"
                    placeholder="Question about your service" 
                    value="Test Email Question">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>
                <textarea id="test-email-body" required rows="4"
                    class="modal-input resize-none"
                    placeholder="What are your business hours?">Hello, I would like to know more about your service. Can you help me with pricing information?</textarea>
            </div>

            <div class="flex space-x-3 pt-4">
                <button type="button" onclick="closeEmailTestModal()"
                    class="flex-1 px-6 py-3 bg-white bg-opacity-10 text-white rounded-xl font-semibold hover:bg-opacity-20 transition-all">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-pink-700 transition-all shadow-lg">
                    <span id="email-send-text">Send Test Email</span>
                    <i id="email-send-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Dashboard JavaScript -->
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>
{% endblock %}